# 真实世界模拟算子

## 功能说明

本算子用于将电子凭证图片合成到真实场景背景中，支持以下功能：

- 自动检测文档角落（基于图像增强和轮廓分析）
- 透视变换合成
- 色彩空间匹配（LAB色彩空间）
- 多种拍摄场景处理（正常、斜拍、阴影、水印、不完整）
- 比例校正防止图像变形
- 自动旋转校正方向
- 支持批量处理多张源图片和背景图片

## 使用场景

- 将电子凭证（如不动产查询结果）合成到真实场景中
- 模拟不同拍摄条件下的效果
- 批量处理多个凭证图片

## 参数说明

| 参数             | 类型     | 默认值 | 说明                                          |
| ---------------- | -------- | ------ | --------------------------------------------- |
| sceneMode        | 下拉选择 | auto   | 场景模式：自动检测/正常/斜拍/阴影/水印/不完整 |
| enableRatioFix   | 开关     | true   | 是否启用比例校正以防止图像变形                |
| enableAutoRotate | 开关     | true   | 是否自动旋转源图以匹配目标方向                |
| outputFormat     | 下拉选择 | path   | 输出格式：图片路径或Base64编码                |

## 场景说明

### 正常场景

适用于正对或微倾斜拍摄的电子凭证，光照均匀。

### 斜拍场景

适用于拍摄角度有透视变形的电子凭证，会进行透视校正。

### 阴影场景

适用于有阴影或光照不均匀的电子凭证，会降低对比度以匹配阴影效果。

### 水印场景

适用于桌面或背景有复杂纹理的电子凭证，使用标准合成算法。

### 不完整场景

适用于凭证部分在画面外的情况，使用标准合成算法。

## 输出示例

### 图片路径格式

```
模拟图片已生成（共2张）:

图片1:
/path/to/不动产查询表_001_1-电子凭证.jpg

图片2:
/path/to/不动产查询表_001_2-电子凭证.jpg
```

### Base64编码格式

```
Base64编码的模拟图片（共2张）:

图片1:
/9j/4AAQSkZJRg...

图片2:
/9j/4AAQSkZJRg...
```

## 注意事项

1. 需要确保 `opencv-python` 和 `numpy` 依赖已安装
2. 源图片目录应从 `sample['export_path']` 获取（上游算子输出）
3. 背景图片目录默认为 `backgrounds`
4. 自动检测使用图像增强和轮廓分析算法
5. 多种场景处理根据文件名关键词分发（3-斜拍、4-阴影、5-水印、6-不完整）
6. 输出为图片路径格式时，第一张图片路径会保存到 `sample['export_path']`
7. 比例校正和自动旋转仅用于优化合成效果

## 版本历史

- v1.0.0: 首次发布
    - 支持真实世界模拟功能
    - 支持多种拍摄场景（正常、斜拍、阴影、水印、不完整）
    - 支持自动检测文档角落
    - 支持透视变换和色彩匹配
    - 支持比例校正和自动旋转
    - 支持批量处理多张源图片和背景图片
    - 支持图片路径和Base64编码两种输出格式
