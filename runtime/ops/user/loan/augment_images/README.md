# 步骤四：图像增强（真实场景合成）- 使用说明

## 简介

本脚本用于将电子凭证图片合成到真实拍摄场景中，生成具有真实感的实景照片。

**注意**：本步骤需要第三步输出的 PNG 图片作为输入。

## 文件说明

```
step4_augment_images_package/
├── step4_augment_images.py   # 主脚本
├── requirements.txt           # 依赖包列表
├── coordinates_cache.json     # 坐标缓存（自动生成/维护）
├── backgrounds/               # 背景图目录
│   ├── 2-桌面实景图.jpg
│   ├── 3-桌面实景图_斜拍.jpg
│   ├── 4-桌面实景图_阴影.jpg
│   ├── 5-桌面实景图_水印.jpg
│   └── 6-桌面实景图_拍摄不完整.jpg
├── src/
│   └── __init__.py            # 包初始化
└── README.md                  # 本说明文件
```

## 安装步骤

### 1. 确保已安装 Python 3.8+

```bash
python --version
```

### 2. 安装依赖包

```bash
pip install -r requirements.txt
```

如果下载慢，使用国内镜像：

```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

## 使用方法

### 准备输入文件

确保有以下内容：
1. 第三步生成的 PNG 图片目录
2. `backgrounds/` 目录下有背景图（已有示例图）

### 基本用法

```bash
# 默认处理第三步的输出
python step4_augment_images.py
```

### 指定输入输出路径

```bash
# 指定输入目录和输出目录
python step4_augment_images.py \
  --input ../step3_convert_images_package/data/step3_images \
  --output data/step4_augmented_images
```

### 完整参数

| 参数 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| --input | -i | data/step3_images | 第三步输出目录 |
| --backgrounds | -b | steps/backgrounds | 背景图目录 |
| --output | -o | data/step4_augmented_images | 输出目录 |
| --skip-detect | - | false | 跳过自动检测，仅使用缓存坐标 |

## 输出说明

运行成功后会在指定目录生成：

```
data/step4_augmented_images/
├── loan_clearance_001_2-桌面实景图.jpg
├── loan_clearance_001_3-桌面实景图_斜拍.jpg
├── loan_clearance_001_4-桌面实景图_阴影.jpg
├── ...
└── _metadata.json
```

**文件命名规则**：`源图名_背景图名.jpg`

## 场景说明

根据背景图文件名，自动选择不同的处理算法：

| 关键词 | 场景 | 说明 |
|--------|------|------|
| `2-` 或无 | 正常拍摄 | 正对或微倾斜，光照均匀 |
| `3-` 或 `斜拍` | 斜拍场景 | 透视变形较大 |
| `4-` 或 `阴影` | 阴影场景 | 光照不均匀，有投影 |
| `5-` 或 `水印` | 水印场景 | 桌面或背景有复杂纹理 |
| `6-` 或 `不完整` | 不完整场景 | 凭证部分在画面外 |

## 坐标缓存机制

本脚本支持**坐标持久化**功能，避免重复标注：

1. **自动检测**：首次运行时自动识别背景图中的文档区域
2. **缓存优先**：检测成功后，坐标保存到 `coordinates_cache.json`
3. **永久复用**：后续运行同一张背景图时，直接使用缓存坐标

### 添加新背景图

1. 将背景图放入 `backgrounds/` 目录
2. 运行脚本，系统会自动检测并保存坐标
3. 下次使用时无需重复检测

### 手动标注

如果自动检测失败，系统会进入手动模式：
1. 弹出窗口显示背景图
2. 依次点击文档的**四个顶点**（顺序不限）
3. 点错按 `r` 键重置
4. 完成后按任意键确认
5. 坐标自动保存到缓存文件

## 使用示例

### 示例1：处理步骤三的输出

```bash
# 假设步骤三的图片在 data/step3_images/
python step4_augment_images.py
```

### 示例2：使用自定义背景图

```bash
# 1. 将你的背景图放入 backgrounds/ 目录
# 2. 运行脚本
python step4_augment_images.py
```

### 示例3：仅使用缓存的坐标

```bash
# 跳过自动检测，加快处理速度
python step4_augment_images.py --skip-detect
```

## 常见问题

### Q: 提示 "找不到输入目录"

**A**: 确保先运行步骤三，或使用 `-i` 参数指定正确的图片目录。

### Q: 自动检测失败怎么办？

**A**:
1. 首次运行会自动进入手动标注模式
2. 按照提示在图上点击四个角点
3. 坐标会自动保存，下次无需重复

### Q: 可以添加自己的背景图吗？

**A**: 可以！将背景图放入 `backgrounds/` 目录即可。支持以下场景：
- 正常拍摄
- 斜拍（文件名包含"斜拍"或"3-"）
- 阴影（文件名包含"阴影"或"4-"）
- 水印（文件名包含"水印"或"5-"）
- 不完整（文件名包含"不完整"或"6-"）

### Q: 生成的图片大小是多少？

**A**: 输出图片尺寸与背景图相同，通常为 3000x2000 或更高分辨率。

### Q: 处理速度慢怎么办？

**A**: 图像增强涉及复杂的计算（透视变换、泊松融合等），单张图片处理时间约 1-3 秒。使用 `--skip-detect` 参数可以跳过检测步骤，加快处理速度。

## 技术原理

本脚本采用以下技术实现真实场景合成：

1. **透视变换** - 校正文档的角度和透视
2. **比例自适应** - 自动补白边防止内容变形
3. **色彩匹配** - LAB 空间光照匹配
4. **泊松融合** - 无缝边缘融合

## 技术支持

如有问题，请联系项目组。

---

**版本**: v1.0
**日期**: 2026-01-25
