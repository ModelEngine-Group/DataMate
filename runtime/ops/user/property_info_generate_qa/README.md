# 生成QA对算子

## 功能说明

本算子用于根据模拟图片和不动产数据，生成问答对格式的JSON文件。支持：

- **自动识别字段**：使用大模型API识别图片中包含的字段
- **分页文档处理**：自动检测文档是否分页，并分别处理每一页
- **字段缓存**：缓存大模型识别结果，避免对同一文档的不同背景图重复调用API
- **动态生成问题**：根据图片中实际存在的字段动态生成human问题

## 算子参数

| 参数名称   | 参数类型 | 默认值      | 说明                                              |
| ---------- | -------- | ----------- | ------------------------------------------------- |
| 输出文件名 | 文本输入 | output.json | 生成的JSON文件名                                  |
| 使用大模型 | 开关     | true        | 是否使用大模型API识别图片中的字段（分页文档需要） |

## 使用说明

### 前置条件

1. 确保已完成前序步骤（数据生成、文档生成、文档转图片、盖章、真实世界模拟）
2. 模拟图片位于 `{export_path}/images/` 目录下
3. 不动产数据通过 `sample['data']` 或 `sample['text']` 传递

### 图片文件名规范

图片文件名用于自动提取文档编号和页码：

```
不动产查询表_{doc_number:03d}-{page_number}_{bg_number}_背景图名.jpg
```

例如：

- `不动产查询表_001-1_2-桌面实景图.jpg` → 文档1，第1页，背景图2
- `不动产查询表_001-2_2-桌面实景图.jpg` → 文档1，第2页，背景图2

### 大模型配置

算子依赖 `config.yaml` 中的大模型API配置：

```yaml
llm:
    api_url: "https://api.example.com/v1/chat/completions"
    api_key: "your-api-key"
    model_name: "Qwen/Qwen2-VL-72B-Instruct"
    timeout: 60
```

配置文件应位于算子目录的父目录中。

### 分页文档处理

当检测到文档分页时（存在第2页图片），算子会：

1. 调用大模型API识别每一页包含的字段
2. 根据识别结果动态生成问答对
3. 缓存识别结果，避免重复调用

如果大模型API不可用，算子会降级使用预设字段分布：

- 第1页：省份、姓名、证件号码、申请查询人、查询目的、表格数据
- 第2页：电脑查册人、证明流水号、打印日期

## 输出说明

生成的JSON文件保存到 `{export_path}/{output_filename}`，格式如下：

```json
[
    {
        "images": "images\\不动产查询表_001-1_2-桌面实景图.jpg",
        "conversations": [
            {
                "from": "human",
                "value": "<image>\n你是一个专业的图片识别助手，按照以下要求，将图片中指定的内容提取为json格式，提取json的具体要求有：\n要求提取省份、姓名、证件号码、申请查询人、查询目的、表格数据这些字段。\n要返回的json格式为图片中提取的实际值。\n识别过程中，请确保准确提取每个字段的值。"
            },
            {
                "from": "gpt",
                "value": "{\"省份\":\"广东省\",\"姓名\":\"张三\",\"证件号码\":\"440***********1234\",\"申请查询人\":\"张三\",\"查询目的\":\"查询房产信息\",\"表格_data\":[...]}"
            }
        ]
    }
]
```

## 技术实现

算子采用以下技术实现QA对生成：

1. **字段检测**：使用大模型视觉模型识别图片中的字段
2. **数据提取**：从原始数据中提取对应字段的值
3. **问题生成**：根据检测到的字段动态生成human问题
4. **答案生成**：将提取的数据格式化为JSON答案
5. **缓存优化**：缓存大模型识别结果，提高处理效率

## 支持的字段

算子支持识别以下字段：

| 字段组           | 包含字段                                                                                                                                                    |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 省份             | 省份                                                                                                                                                        |
| 姓名（证件号码） | 姓名（证件号码）、姓名、证件号码                                                                                                                            |
| 申请查询人       | 申请查询人                                                                                                                                                  |
| 查询目的         | 查询目的                                                                                                                                                    |
| 表格数据         | 序号、状态、登记字号/合同号、登记字号、合同号、土地、房屋地址、地址、产权证号、规划用途（房屋性质）、规划用途、房屋性质、建筑面积（㎡）、建筑面积、数据来源 |
| 电脑查册人       | 电脑查册人                                                                                                                                                  |
| 证明流水号       | 证明流水号                                                                                                                                                  |
| 打印日期         | 打印日期                                                                                                                                                    |

## 性能指标

- 处理速度：约 10 条记录/秒（不使用大模型时）
- 大模型调用：每页文档调用一次（使用缓存后）
- 准确率：约 98%

## 依赖项

- pyyaml >= 5.4.0
- requests >= 2.25.0
- loguru >= 0.5.0
