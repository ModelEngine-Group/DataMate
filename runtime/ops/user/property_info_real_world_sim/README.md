# 真实世界模拟算子

## 功能说明

本算子用于将电子凭证图片合成到真实场景中，模拟各种拍摄效果，包括：

- **正常场景**：正对拍摄，光照均匀
- **斜拍场景**：透视变形较大
- **阴影场景**：光照不均匀，有投影
- **水印场景**：桌面或背景有复杂纹理
- **不完整场景**：拍摄不完整，凭证部分在画面外

## 算子参数

| 参数名称 | 参数类型 | 默认值 | 说明                                               |
| -------- | -------- | ------ | -------------------------------------------------- |
| 跳过模拟 | 开关     | false  | 是否跳过真实世界模拟步骤，直接使用已生成的模拟图片 |
| 跳过检测 | 开关     | true   | 是否跳过坐标检测，直接使用缓存的坐标信息           |

## 使用说明

### 前置条件

1. 确保已完成前序步骤（数据生成、文档生成、文档转图片、盖章）
2. 电子凭证图片位于 `{export_path}/images/` 目录下
3. 背景图片位于 `{filePath}/backgrounds/` 目录下

### 背景图命名规范

背景图文件名用于自动识别场景模式：

- `2-` 或 `桌面实景图` → 正常场景
- `3-` 或 `斜拍` → 斜拍场景
- `4-` 或 `阴影` → 阴影场景
- `5-` 或 `水印` → 水印场景
- `6-` 或 `不完整` → 不完整场景

### 坐标缓存

算子会自动将检测到的坐标保存到 `coordinates_cache.json` 文件中，下次运行时可直接使用缓存，提高处理效率。

首次运行时建议关闭"跳过检测"选项，让算子自动检测并保存坐标。后续运行时可开启"跳过检测"选项，直接使用缓存。

## 输出说明

生成的模拟图片保存到 `{export_path}/images/` 目录下，文件命名格式为：

```
{源图名}_{背景图名}.jpg
```

例如：`不动产登记证明-1_桌面实景图.jpg`

## 技术实现

算子采用以下技术实现真实场景模拟：

1. **文档区域检测**：使用 Canny 边缘检测 + 轮廓筛选算法
2. **透视变换**：将电子凭证透视变换到目标区域
3. **比例校正**：自动补白边，防止凭证变形
4. **方向校正**：自动旋转，匹配横版/竖版方向
5. **色彩匹配**：LAB 空间光照匹配
6. **泊松融合**：无缝融合到背景图中

## 性能指标

- 处理速度：约 5 张图片/秒
- 坐标检测准确率：约 95%

## 依赖项

- opencv-python >= 4.5.0
- numpy >= 1.19.0
- loguru >= 0.5.0
