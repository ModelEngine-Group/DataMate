# 标注生成算子 - 使用说明

## 简介

本算子用于根据原始JSON数据生成问答对，并输出为JSONL格式数据集，用于多模态VL模型训练。

## 文件说明

```
generate_annotations/
├── __init__.py                  # 包初始化
├── README.md                    # 本说明文件
├── metadata.yml                 # 算子元数据
├── process.py                   # 主脚本
├── requirements.txt              # 依赖包列表
└── src/
    ├── __init__.py              # 源模块初始化
    └── qa_generator.py        # QA生成模块
```

## 安装步骤

### 1. 确保已安装 Python 3.8+

```bash
python --version
```

### 2. 安装依赖包

本算子仅使用Python标准库，无需额外依赖。

## 使用方法

### 基本用法（批量生成QA对）

```bash
python process.py
```

### 前置条件

运行前需要满足以下条件：

1. **数据文件存在**：`../data/` 目录下需要有 JSON 数据文件
2. **图片文件存在**：`../output/03_simulated/` 目录下需要有模拟图片

如果数据文件不存在，请先运行：

```bash
cd ../tax_generate_data
python process.py
```

如果图片文件不存在，请先运行：

```bash
cd ../augment_images
python process.py
```

## 问答对生成逻辑

### 问题库

本算子内置了以下问题模板，会随机抽取指定数量的问题：

1. "这份证明是给哪位纳税人开具的？"
2. "纳税人的身份证件类型和号码是什么？"
3. "凭证编码和填发日期分别是多少？"
4. "这份证明是关于哪一年的纳税情况？"
5. "请列出所有的纳税项目。"
6. "税款金额合计是多少？"
7. "工资、薪金所得小计是多少？"
8. "劳务报酬所得是多少？"
9. "稿酬所得是多少？"

### 对话格式

每个问答对包含以下内容：

- **第一轮对话（固定）**：文档类型识别
  - User: `<image>\n这是什么类型的文档？`
  - Assistant: `这是一份个人所得税完税证明。`

- **中间对话（随机）**：从问题库中随机抽取

- **最后一轮对话（固定）**：结构化JSON提取
  - User: `请提取所有关键信息，以严格的JSON格式输出，不要包含额外的文本。`
  - Assistant: `{"文件名称": "...", "纳税人姓名": "...", ...}`

### 自定义配置

可以在 `process.py` 中修改以下参数：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| random_questions | 8 | 每个数据随机生成的问题数量 |

## 输出说明

运行成功后会在 `output/04_jsonl/` 目录生成 JSONL 格式数据集。

### JSONL 格式

每一行是一个 JSON 对象，包含以下字段：

```json
{
  "image": "张三_个人所得税完税证明_2-个人所得税完税证明_正常_01.jpg",
  "messages": [
    {"role": "usr", "content": "<image>\n这是什么类型的文档？"},
    {"role": "assistant", "content": "这是一份个人所得税完税证明。"},
    {"role": "usr", "content": "这份证明是给哪位纳税人开具的？"},
    {"role": "assistant", "content": "纳税人姓名是：张三。"},
    ...
  ]
}
```

### 字段说明

- **image**: 图片文件名（相对于 `output/03_simulated/` 目录）
- **messages**: 对话消息列表
  - **role**: 角色（`usr` 表示用户，`assistant` 表示助手）
  - **content**: 消息内容

## 数据文件匹配规则

本算子会自动匹配数据文件与图片文件：

1. **匹配规则**：根据文件名基础部分进行匹配
   - 数据文件：`张三_个人所得税完税证明.json`
   - 相关图片：`张三_个人所得税完税证明_*.jpg`

2. **一对多关系**：一个数据文件对应多张图片（不同场景的模拟图片）
   - 正常场景图片
   - 斜拍场景图片
   - 阴影场景图片
   - 水印场景图片
   - 拍摄不完整场景图片

3. **每个组合都会生成独立的QA对**：同一数据的每张图片都会生成单独的问答对

## 输出目录结构

```
output/
└── 04_jsonl/
    └── 个人所得税完税证明_dataset.jsonl
```

## 数据集统计

假设有：
- 10 个数据文件
- 每个数据有 5 张不同场景的图片
- 每个组合生成 10 条问答对（1固定 + 8随机 + 1JSON提取）

最终生成的记录数：
```
总记录数 = 10 (数据) × 5 (场景) = 50 条
每条记录平均对话轮数 ≈ 10 轮
```

## 常见问题

### Q1: 提示"找不到JSON文件"

**A**: 确保 `../data/` 目录下有 JSON 文件，请先运行：
```bash
cd ../tax_generate_data
python process.py
```

### Q2: 提示"找不到图片文件"

**A**: 确保 `../output/03_simulated/` 目录下有 JPG 图片，请先运行：
```bash
cd ../augment_images
python process.py
```

### Q3: 生成的数据集为空

**A**:
1. 检查数据文件和图片文件的文件名是否匹配
2. 确保数据文件的基础名称与图片文件的基础名称一致
3. 检查是否有文件命名不统一的问题

### Q4: 如何修改问题库

**A**: 在 `src/qa_generator.py` 中修改 `questions` 列表，添加或删除问题模板。

### Q5: 如何修改随机问题数量

**A**: 在 `process.py` 中修改 `random_questions` 参数：
```python
generator = QAGenerator(random_questions=15)  # 生成15个问题
```

### Q6: JSONL文件过大

**A**:
1. 减少数据文件数量（在 generate_data/process.py 中）
2. 减少背景图数量（删除不需要的场景）
3. 减少随机问题数量（修改 `random_questions` 参数）

### Q7: 如何自定义JSON输出格式

**A**: 在 `src/qa_generator.py` 中修改 `generate_qa_pairs` 函数的最后一部分，自定义 `json_output` 字典的结构。

### Q8: 生成的QA对中包含不需要的字段

**A**: 在 `src/qa_generator.py` 中修改 `json_output` 字典，只保留需要的字段。

## 技术支持

如有问题，请联系项目组。

---

**版本**: v1.0
**日期**: 2026-01-28
