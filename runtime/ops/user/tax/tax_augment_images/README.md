# 图片增强算子 - 使用说明

## 简介

本算子用于将生成的JPG图片与真实世界背景图合成，模拟多种拍摄场景。

## 文件说明

```
augment_images/
├── __init__.py                  # 包初始化
├── README.md                    # 本说明文件
├── metadata.yml                 # 算子元数据
├── process.py                   # 主脚本
├── requirements.txt              # 依赖包列表
├── backgrounds/                 # 真实世界背景图库
│   ├── 2-个人所得税完税证明_正常_*.jpg
│   ├── 3-个人所得税完税证明_斜拍_*.jpg
│   ├── 4-个人所得税完税证明_阴影_*.jpg
│   ├── 5-个人所得税完税证明_水印_*.jpg
│   └── 6-个人所得税完税证明_拍摄不完整_*.jpg
└── src/
    ├── __init__.py              # 源模块初始化
    └── image_augmenter.py       # 图片增强模块
```

## 安装步骤

### 1. 确保已安装 Python 3.8+

```bash
python --version
```

### 2. 安装依赖包

```bash
pip install -r requirements.txt
```

如果下载慢，使用国内镜像：

```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

## 使用方法

### 基本用法（批量合成）

```bash
python process.py
```

### 前置条件

运行前需要满足以下条件：

1. **源图片存在**：`../output/02_images/` 目录下需要有 JPG 图片
2. **背景图存在**：`../backgrounds/` 目录下需要有背景图

如果源图片不存在，请先运行：

```bash
cd ../flow_convert_images
python process.py
```

## 支持的场景

本算子支持5种真实世界拍摄场景，根据背景图文件名前缀自动识别：

### 1. 正常拍摄（2-* 或不包含特殊标识）

- **特征**：正对或微倾斜，光照均匀
- **处理**：透视变换 + 色彩匹配 + 泊松融合

### 2. 斜拍（3-* 或包含"斜拍"）

- **特征**：透视变形较大
- **处理**：自动旋转校正 + 比例自适应 + 透视变换

### 3. 阴影（4-* 或包含"阴影"）

- **特征**：光照不均匀，有投影
- **处理**：降低对比度 + 色彩匹配

### 4. 水印（5-* 或包含"水印"）

- **特征**：桌面或背景有复杂纹理
- **处理**：自动旋转校正 + 比例自适应

### 5. 拍摄不完整（6-* 或包含"不完整"）

- **特征**：凭证部分在画面外
- **处理**：正常场景处理

## 坐标缓存机制

为提高处理效率，本算子实现了坐标缓存机制：

1. **首次运行**：
   - 自动识别背景图中的凭证区域
   - 将识别结果保存到 `coordinates_cache.json`

2. **后续运行**：
   - 直接从缓存文件加载坐标
   - 跳过自动识别步骤，大幅提升速度

3. **自动识别失败**：
   - 进入手动辅助模式
   - 弹出窗口让用户点击4个角点
   - 手动标记的坐标也会缓存

4. **坐标文件格式**：

```json
{
  "backgrounds/xxx.jpg": [
    [x1, y1],
    [x2, y2],
    [x3, y3],
    [x4, y4]
  ],
  ...
}
```

## 输出说明

运行成功后会在 `output/03_simulated/` 目录生成合成图片，文件名格式为：`{源文件名}_{背景图名}.jpg`

## 输出目录结构

```
output/
└── 03_simulated/
    ├── 张三_个人所得税完税证明_2-个人所得税完税证明_正常_01.jpg
    ├── 张三_个人所得税完税证明_3-个人所得税完税证明_斜拍_01.jpg
    ├── 张三_个人所得税完税证明_4-个人所得税完税证明_阴影_01.jpg
    └── ...
```

## 技术原理

### 1. 智能坐标识别

- **图像预处理**：双边滤波 + CLAHE 对比度增强
- **边缘检测**：Canny 算法 + 自动阈值计算
- **轮廓提取**：按面积排序提取前5个轮廓
- **多边形拟合**：Douglas-Peucker 算法

### 2. 透视变换

- **自动旋转**：检测源图和目标区域方向是否一致
- **比例校正**：自动计算宽高比，添加白色边框避免变形
- **透视变换**：使用 `cv2.getPerspectiveTransform` 计算变换矩阵

### 3. 色彩匹配

- **色彩空间转换**：BGR → LAB
- **亮度匹配**：统计源图和目标区域的亮度均值和标准差
- **对比度调整**：根据场景类型调整对比度因子

### 4. 泊松融合

- **克隆模式**：`cv2.NORMAL_CLONE` - 正常克隆
- **融合原理**：梯度域融合，实现无缝合成

## 常见问题

### Q1: 提示"找不到模块 'cv2'"

**A**: 请先安装依赖：`pip install opencv-python`

### Q2: 提示"找不到模块 'numpy'"

**A**: 请先安装依赖：`pip install numpy`

### Q3: 提示"源目录不存在"

**A**: 请先运行 `convert_images/process.py` 生成JPG图片

### Q4: 提示"背景目录不存在"

**A**: 确认 `backgrounds/` 目录下有背景图文件

### Q5: 自动识别总是失败

**A**:
1. 检查背景图中的凭证区域是否清晰可见
2. 手动模式下按照提示点击四个角点
3. 确保按顺序点击（左上、右上、右下、左下）
4. 点错可以按 'r' 重置

### Q6: 坐标缓存文件损坏

**A**: 删除 `coordinates_cache.json` 文件，重新运行会自动生成

### Q7: 融合失败，显示降级为直接覆盖

**A**:
1. 这是正常现象，说明泊松融合失败但使用了备用方案
2. 备用方案直接覆盖图像，可能影响融合效果
3. 检查 OpenCV 版本是否支持 `seamlessClone`

### Q8: 生成图片有黑边

**A**:
1. 检查比例校正是否启用（默认已启用）
2. 可能是目标区域宽高比与源图不匹配
3. 尝试调整背景图或使用不同场景的背景图

### Q9: 中文路径问题

**A**: 代码已内置中文路径支持，使用 `cv2.imdecode` 读取图片

### Q10: 如何自定义场景类型

**A**: 修改背景图文件名，添加对应的前缀：
- 正常：`2-` 或不加前缀
- 斜拍：`3-` 或包含"斜拍"
- 阴影：`4-` 或包含"阴影"
- 水印：`5-` 或包含"水印"
- 不完整：`6-` 或包含"不完整"

## 技术支持

如有问题，请联系项目组。

---

**版本**: v1.0
**日期**: 2026-01-28
